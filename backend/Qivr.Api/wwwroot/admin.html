<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QIVR Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f7f7f7;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a67d8;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        button.secondary {
            background: #6b7280;
        }

        button.secondary:hover {
            background: #4b5563;
        }

        .search-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 300px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #10b981;
            color: white;
        }

        .status-suspended {
            background: #f59e0b;
            color: white;
        }

        .status-cancelled {
            background: #ef4444;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success {
            background: #efe;
            color: #060;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z"></path>
                    <path d="M2 17L12 22L22 17"></path>
                    <path d="M2 12L12 17L22 12"></path>
                </svg>
                QIVR Admin Dashboard
            </h1>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="tenants">Tenants</button>
            <button class="tab" data-tab="users">Users</button>
            <button class="tab" data-tab="tools">Tools</button>
        </div>

        <div class="content">
            <div id="message"></div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content">
                <h2>System Overview</h2>
                <div class="stats-grid" id="stats"></div>
            </div>

            <!-- Tenants Tab -->
            <div id="tenants" class="tab-content" style="display: none;">
                <div class="actions">
                    <h2>Tenant Management</h2>
                    <div>
                        <input type="text" class="search-box" placeholder="Search tenants..." id="tenantSearch">
                        <button onclick="showCreateTenantModal()">+ Create Tenant</button>
                    </div>
                </div>
                <div id="tenantsTable"></div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content" style="display: none;">
                <div class="actions">
                    <h2>User Management</h2>
                    <div>
                        <input type="text" class="search-box" placeholder="Search users..." id="userSearch">
                        <button onclick="loadUsers()">Refresh</button>
                    </div>
                </div>
                <div id="usersTable"></div>
            </div>

            <!-- Tools Tab -->
            <div id="tools" class="tab-content" style="display: none;">
                <h2>Admin Tools</h2>
                <div style="display: grid; gap: 20px; margin-top: 20px;">
                    <div>
                        <h3>Test Data</h3>
                        <p>Seed the database with test tenants and users for development.</p>
                        <button onclick="seedTestData()">Seed Test Data</button>
                    </div>
                    <div>
                        <h3>CORS Test</h3>
                        <p>Test CORS configuration for the API.</p>
                        <button onclick="testCors()">Test CORS</button>
                    </div>
                    <div>
                        <h3>Generate Dev Token</h3>
                        <p>Generate a development JWT token for testing.</p>
                        <button onclick="generateDevToken()">Generate Token</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tenant Modal -->
    <div id="createTenantModal" class="modal">
        <div class="modal-content">
            <h2>Create New Tenant</h2>
            <form id="createTenantForm">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Slug</label>
                    <input type="text" name="slug" required pattern="[a-z0-9-]+">
                </div>
                <div class="form-group">
                    <label>Plan</label>
                    <select name="plan">
                        <option value="starter">Starter</option>
                        <option value="professional">Professional</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Timezone</label>
                    <input type="text" name="timezone" value="Australia/Sydney">
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary" onclick="hideModal('createTenantModal')">Cancel</button>
                    <button type="submit">Create Tenant</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Tenant Modal -->
    <div id="editTenantModal" class="modal">
        <div class="modal-content">
            <h2>Edit Tenant</h2>
            <form id="editTenantForm">
                <input type="hidden" name="id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Slug</label>
                    <input type="text" name="slug" required pattern="[a-z0-9-]+">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Active">Active</option>
                        <option value="Suspended">Suspended</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Plan</label>
                    <select name="plan">
                        <option value="starter">Starter</option>
                        <option value="professional">Professional</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary" onclick="hideModal('editTenantModal')">Cancel</button>
                    <button type="submit">Update Tenant</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/superadmin';
        let currentTenants = [];
        let currentUsers = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOverview();
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Search functionality
            document.getElementById('tenantSearch').addEventListener('input', filterTenants);
            document.getElementById('userSearch').addEventListener('input', filterUsers);

            // Form handlers
            document.getElementById('createTenantForm').addEventListener('submit', createTenant);
            document.getElementById('editTenantForm').addEventListener('submit', updateTenant);
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';

            // Load data for the tab
            switch(tabName) {
                case 'overview':
                    loadOverview();
                    break;
                case 'tenants':
                    loadTenants();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showMessage('API call failed: ' + error.message, 'error');
                throw error;
            }
        }

        function showMessage(message, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.className = type;
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        async function loadOverview() {
            try {
                const stats = await apiCall(`${API_BASE}/health`);
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Tenants</h3>
                        <div class="value">${stats.tenantCount || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Tenants</h3>
                        <div class="value">${stats.activeTenants || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value">${stats.userCount || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Patients</h3>
                        <div class="value">${stats.patientCount || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Staff</h3>
                        <div class="value">${stats.staffCount || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Environment</h3>
                        <div class="value" style="font-size: 18px;">${stats.environment || 'Unknown'}</div>
                    </div>
                `;
                document.getElementById('stats').innerHTML = statsHtml;
            } catch (error) {
                document.getElementById('stats').innerHTML = '<div class="error">Failed to load stats</div>';
            }
        }

        async function loadTenants() {
            try {
                document.getElementById('tenantsTable').innerHTML = '<div class="loading">Loading tenants...</div>';
                currentTenants = await apiCall(`${API_BASE}/tenants`);
                renderTenants(currentTenants);
            } catch (error) {
                document.getElementById('tenantsTable').innerHTML = '<div class="error">Failed to load tenants</div>';
            }
        }

        function renderTenants(tenants) {
            if (!tenants || tenants.length === 0) {
                document.getElementById('tenantsTable').innerHTML = '<div class="loading">No tenants found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Slug</th>
                            <th>Status</th>
                            <th>Plan</th>
                            <th>Users</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tenants.map(tenant => `
                            <tr>
                                <td>${tenant.name}</td>
                                <td>${tenant.slug}</td>
                                <td><span class="status-badge status-${tenant.status?.toLowerCase() || 'active'}">${tenant.status || 'Active'}</span></td>
                                <td>${tenant.plan || 'starter'}</td>
                                <td>${tenant.userCount || 0}</td>
                                <td>${new Date(tenant.createdAt).toLocaleDateString()}</td>
                                <td>
                                    <button onclick="editTenant('${tenant.id}')">Edit</button>
                                    <button onclick="toggleTenantStatus('${tenant.id}')" class="secondary">Toggle Status</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('tenantsTable').innerHTML = html;
        }

        function filterTenants() {
            const search = document.getElementById('tenantSearch').value.toLowerCase();
            const filtered = currentTenants.filter(t => 
                t.name.toLowerCase().includes(search) || 
                t.slug.toLowerCase().includes(search)
            );
            renderTenants(filtered);
        }

        async function loadUsers() {
            try {
                document.getElementById('usersTable').innerHTML = '<div class="loading">Loading users...</div>';
                currentUsers = await apiCall(`${API_BASE}/users`);
                renderUsers(currentUsers);
            } catch (error) {
                document.getElementById('usersTable').innerHTML = '<div class="error">Failed to load users</div>';
            }
        }

        function renderUsers(users) {
            if (!users || users.length === 0) {
                document.getElementById('usersTable').innerHTML = '<div class="loading">No users found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Tenant</th>
                            <th>Verified</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.email}</td>
                                <td>${user.fullName || `${user.firstName || ''} ${user.lastName || ''}`.trim() || '-'}</td>
                                <td>${user.userType || 'Patient'}</td>
                                <td>${user.tenantName || '-'}</td>
                                <td>${user.emailVerified ? '✓' : '✗'}</td>
                                <td>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString() : 'Never'}</td>
                                <td>
                                    <button onclick="resetPassword('${user.id}')">Reset Password</button>
                                    <button onclick="toggleUserDelete('${user.id}')" class="${user.isDeleted ? 'secondary' : 'danger'}">
                                        ${user.isDeleted ? 'Restore' : 'Delete'}
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('usersTable').innerHTML = html;
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const filtered = currentUsers.filter(u => 
                u.email.toLowerCase().includes(search) || 
                (u.firstName && u.firstName.toLowerCase().includes(search)) ||
                (u.lastName && u.lastName.toLowerCase().includes(search))
            );
            renderUsers(filtered);
        }

        function showCreateTenantModal() {
            document.getElementById('createTenantModal').classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function createTenant(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                slug: formData.get('slug'),
                plan: formData.get('plan'),
                timezone: formData.get('timezone')
            };

            try {
                await apiCall(`${API_BASE}/tenants`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showMessage('Tenant created successfully');
                hideModal('createTenantModal');
                loadTenants();
            } catch (error) {
                showMessage('Failed to create tenant', 'error');
            }
        }

        function editTenant(tenantId) {
            const tenant = currentTenants.find(t => t.id === tenantId);
            if (!tenant) return;

            const form = document.getElementById('editTenantForm');
            form.elements.id.value = tenant.id;
            form.elements.name.value = tenant.name;
            form.elements.slug.value = tenant.slug;
            form.elements.status.value = tenant.status || 'Active';
            form.elements.plan.value = tenant.plan || 'starter';

            document.getElementById('editTenantModal').classList.add('show');
        }

        async function updateTenant(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tenantId = formData.get('id');
            const data = {
                name: formData.get('name'),
                slug: formData.get('slug'),
                status: formData.get('status'),
                plan: formData.get('plan')
            };

            try {
                await apiCall(`${API_BASE}/tenants/${tenantId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showMessage('Tenant updated successfully');
                hideModal('editTenantModal');
                loadTenants();
            } catch (error) {
                showMessage('Failed to update tenant', 'error');
            }
        }

        async function toggleTenantStatus(tenantId) {
            try {
                await apiCall(`${API_BASE}/tenants/${tenantId}/toggle-status`, {
                    method: 'POST'
                });
                showMessage('Tenant status toggled');
                loadTenants();
            } catch (error) {
                showMessage('Failed to toggle tenant status', 'error');
            }
        }

        async function resetPassword(userId) {
            const newPassword = prompt('Enter new password:');
            if (!newPassword) return;

            try {
                await apiCall(`${API_BASE}/users/${userId}/reset-password`, {
                    method: 'POST',
                    body: JSON.stringify({ newPassword })
                });
                showMessage('Password reset successfully');
            } catch (error) {
                showMessage('Failed to reset password', 'error');
            }
        }

        async function toggleUserDelete(userId) {
            if (!confirm('Are you sure?')) return;

            try {
                await apiCall(`${API_BASE}/users/${userId}/toggle-delete`, {
                    method: 'POST'
                });
                showMessage('User status updated');
                loadUsers();
            } catch (error) {
                showMessage('Failed to update user', 'error');
            }
        }

        async function seedTestData() {
            if (!confirm('This will seed test data. Continue?')) return;

            try {
                const result = await apiCall(`${API_BASE}/seed-test-data`, {
                    method: 'POST'
                });
                showMessage('Test data seeded successfully');
                console.log('Seeded data:', result);
            } catch (error) {
                showMessage('Failed to seed test data', 'error');
            }
        }

        async function testCors() {
            try {
                const result = await apiCall(`${API_BASE}/cors-test`);
                showMessage('CORS test successful');
                console.log('CORS test result:', result);
            } catch (error) {
                showMessage('CORS test failed', 'error');
            }
        }

        async function generateDevToken() {
            try {
                const result = await apiCall('/api/auth/dev-token', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'admin@qivr.health',
                        role: 'SuperAdmin',
                        tenantId: '11111111-1111-1111-1111-111111111111'
                    })
                });
                console.log('Generated token:', result.token);
                prompt('Dev token generated (also in console):', result.token);
            } catch (error) {
                showMessage('Failed to generate token', 'error');
            }
        }
    </script>
</body>
</html>
