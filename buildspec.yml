version: 0.2

env:
  variables:
    FORCE_BUILD_ALL: "false"
    ENVIRONMENT: "production"  # Can be overridden: staging or production

phases:
  install:
    runtime-versions:
      nodejs: 20

  pre_build:
    commands:
      - echo "Deploying to $ENVIRONMENT environment"
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/qivr-api
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      
      # Set image tag based on environment
      - |
        if [ "$ENVIRONMENT" = "staging" ]; then
          IMAGE_TAG="staging"
          ECS_SERVICE="qivr-api-staging"
          CLINIC_BUCKET="qivr-clinic-dashboard-staging"
          PATIENT_BUCKET="qivr-patient-portal-staging"
          CLINIC_CF_ID="E3HJR6LSRFIAEY"
          PATIENT_CF_ID="E3MU2DHOBIDQ91"
          SSM_PARAM="/qivr/staging/last-successful-build"
        else
          IMAGE_TAG="${COMMIT_HASH:=latest}"
          ECS_SERVICE="qivr-api"
          CLINIC_BUCKET="qivr-clinic-dashboard-production"
          PATIENT_BUCKET="qivr-patient-portal-production"
          CLINIC_CF_ID="E1S9SAZB57T3C3"
          PATIENT_CF_ID="E39OVJDZIZ22QL"
          SSM_PARAM="/qivr/last-successful-build"
        fi
        echo "IMAGE_TAG=$IMAGE_TAG ECS_SERVICE=$ECS_SERVICE"

      # Detect what changed since last successful build
      - |
        echo "Detecting changes..."
        PREV_COMMIT=$(aws ssm get-parameter --name $SSM_PARAM --query Parameter.Value --output text 2>/dev/null || echo "")
        if [ -z "$PREV_COMMIT" ] || [ "$FORCE_BUILD_ALL" = "true" ]; then
          echo "No previous build found or force build - building all"
          BUILD_BACKEND=true
          BUILD_CLINIC=true
          BUILD_PATIENT=true
          BUILD_ADMIN=false
          BUILD_PARTNER=false
          BUILD_WIDGET=true
        else
          echo "Comparing $PREV_COMMIT to $CODEBUILD_RESOLVED_SOURCE_VERSION"
          git fetch --depth=100 origin main 2>/dev/null || true
          CHANGED_FILES=$(git diff --name-only $PREV_COMMIT $CODEBUILD_RESOLVED_SOURCE_VERSION 2>/dev/null || echo "")
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected or git diff failed - building all to be safe"
            BUILD_BACKEND=true; BUILD_CLINIC=true; BUILD_PATIENT=true; BUILD_ADMIN=false; BUILD_PARTNER=false; BUILD_WIDGET=true
          else
            BUILD_BACKEND=$(echo "$CHANGED_FILES" | grep -q "^backend/\|^packages/" && echo true || echo false)
            BUILD_CLINIC=$(echo "$CHANGED_FILES" | grep -q "^apps/clinic-dashboard/\|^packages/" && echo true || echo false)
            BUILD_PATIENT=$(echo "$CHANGED_FILES" | grep -q "^apps/patient-portal/\|^packages/" && echo true || echo false)
            BUILD_ADMIN=false
            BUILD_PARTNER=false
            BUILD_WIDGET=$(echo "$CHANGED_FILES" | grep -q "^apps/intake-widget/\|^packages/" && echo true || echo false)
          fi
        fi
        echo "BUILD_BACKEND=$BUILD_BACKEND BUILD_CLINIC=$BUILD_CLINIC BUILD_PATIENT=$BUILD_PATIENT"

      - docker buildx create --name multi --use 2>/dev/null || docker buildx use multi
      - docker buildx inspect --bootstrap

  build:
    commands:
      - echo Build started on `date`

      # Build Docker image if backend changed
      - |
        if [ "$BUILD_BACKEND" = "true" ]; then
          echo "Building and pushing Docker image with tag $IMAGE_TAG..."
          docker buildx build --platform linux/amd64 -t $REPOSITORY_URI:$IMAGE_TAG -t $REPOSITORY_URI:latest --push ./backend
          echo "Docker build and push completed"
        else
          echo "Skipping backend build - no changes"
        fi

      # Only install deps if any frontend needs building
      - |
        if [ "$BUILD_CLINIC" = "true" ] || [ "$BUILD_PATIENT" = "true" ] || [ "$BUILD_WIDGET" = "true" ]; then
          echo "Installing Node.js dependencies..."
          npm ci --legacy-peer-deps 2>/dev/null || npm install --legacy-peer-deps
          echo "Building shared packages..."
          cd packages/http && npm run build && cd ../..
          cd packages/eval && npm run build && cd ../..
          cd packages/design-system && npm run build && cd ../..
        fi

      # Build frontends with correct environment
      - |
        PIDS=""
        if [ "$BUILD_CLINIC" = "true" ]; then
          echo "Building clinic-dashboard for $ENVIRONMENT..."
          if [ "$ENVIRONMENT" = "staging" ]; then
            (cd apps/clinic-dashboard && VITE_API_URL=https://staging-api.qivr.pro npm run build) &
          else
            (cd apps/clinic-dashboard && npm run build) &
          fi
          PIDS="$PIDS $!"
        fi
        if [ "$BUILD_PATIENT" = "true" ]; then
          echo "Building patient-portal for $ENVIRONMENT..."
          if [ "$ENVIRONMENT" = "staging" ]; then
            (cd apps/patient-portal && VITE_API_URL=https://staging-api.qivr.pro npm run build) &
          else
            (cd apps/patient-portal && npm run build) &
          fi
          PIDS="$PIDS $!"
        fi
        if [ "$BUILD_WIDGET" = "true" ]; then
          echo "Building intake-widget..."
          (cd apps/intake-widget && npm run build) &
          PIDS="$PIDS $!"
        fi
        for pid in $PIDS; do wait $pid; done

  post_build:
    commands:
      - echo Build completed on `date`

      # Update ECS service
      - |
        if [ "$BUILD_BACKEND" = "true" ]; then
          echo "Updating ECS service $ECS_SERVICE..."
          if [ "$ENVIRONMENT" = "staging" ]; then
            TASK_DEF="qivr-api-staging"
          else
            TASK_DEF="qivr-api"
          fi
          sed "s|IMAGE_URI_PLACEHOLDER|$REPOSITORY_URI:$IMAGE_TAG|g" task-definition-template.json > task-definition-new.json
          NEW_TASK_DEF=$(aws ecs register-task-definition --cli-input-json file://task-definition-new.json --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster qivr_cluster --service $ECS_SERVICE --task-definition $NEW_TASK_DEF --force-new-deployment
          printf '[{"name":"qivr-api","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
        else
          echo '[]' > imagedefinitions.json
        fi

      # Deploy frontends to correct S3 buckets
      - |
        if [ "$BUILD_CLINIC" = "true" ]; then
          echo "Deploying clinic-dashboard to $CLINIC_BUCKET..."
          aws s3 sync apps/clinic-dashboard/dist/ s3://$CLINIC_BUCKET --delete --region $AWS_DEFAULT_REGION || echo "Warning: clinic-dashboard deploy failed"
        fi
        if [ "$BUILD_PATIENT" = "true" ]; then
          echo "Deploying patient-portal to $PATIENT_BUCKET..."
          aws s3 sync apps/patient-portal/dist/ s3://$PATIENT_BUCKET --delete --region $AWS_DEFAULT_REGION || echo "Warning: patient-portal deploy failed"
        fi
        if [ "$BUILD_WIDGET" = "true" ]; then
          echo "Deploying intake-widget..."
          aws s3 sync apps/intake-widget/dist/ s3://qivr-intake-widget --delete --region $AWS_DEFAULT_REGION || echo "Warning: intake-widget deploy failed"
        fi

      # Invalidate CloudFront
      - |
        if [ "$BUILD_CLINIC" = "true" ] && [ -n "$CLINIC_CF_ID" ]; then
          echo "Invalidating CloudFront $CLINIC_CF_ID..."
          aws cloudfront create-invalidation --distribution-id $CLINIC_CF_ID --paths "/*" || true
        fi
        if [ "$BUILD_PATIENT" = "true" ] && [ -n "$PATIENT_CF_ID" ]; then
          echo "Invalidating CloudFront $PATIENT_CF_ID..."
          aws cloudfront create-invalidation --distribution-id $PATIENT_CF_ID --paths "/*" || true
        fi

      # Store successful build commit
      - aws ssm put-parameter --name $SSM_PARAM --value $CODEBUILD_RESOLVED_SOURCE_VERSION --type String --overwrite

artifacts:
  files:
    - imagedefinitions.json
